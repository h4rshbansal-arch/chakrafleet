/**
 * Core Philosophy: This ruleset enforces a Role-Based Access Control (RBAC) model for the EZTransport application.
 * A user's role, stored on their user document, is the primary factor in determining their permissions across the database.
 * The three roles are Admin, Supervisor, and Driver, each with a distinct set of capabilities.
 *
 * Data Structure: The database uses a flat hierarchy of top-level collections (users, vehicles, jobs, etc.).
 * Authorization data, such as user roles or job assignment IDs, is denormalized directly onto the documents being
 * secured. This is a critical design choice that avoids slow and costly `get()` calls in most rules, leading to
 * better performance and simpler logic. The one exception is fetching the current user's role from their own
 * /users/{userId} document, which is a standard and acceptable pattern for RBAC.
 *
 * Key Security Decisions:
 * - User Privacy: Users can only access their own profile document in the `/users` collection. Listing all users is strictly forbidden to protect user privacy, except for Admins who need it for management purposes.
 * - Role-Based Permissions: Admins have wide-ranging read/write access. Supervisors have permissions focused on job management. Drivers have limited read access, typically restricted to jobs they are assigned to.
 * - System-Generated Data: Collections like `activity_logs` and `ai_suggestions` are treated as immutable and cannot be created or modified by any client-side user. This ensures data integrity, as these records should only be created by a trusted backend process using the Admin SDK.
 * - Default Posture: The default security posture is to deny access. Permissions are granted explicitly and on a need-to-know basis according to the user's role.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the foundation for document ownership checks.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * A wrapper for update/delete operations to ensure a document exists
     * before an ownership check is performed. Prevents invalid writes.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Retrieves the role of the currently authenticated user from their user profile.
     * This is the core function for the Role-Based Access Control (RBAC) system.
     */
    function getUserData() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /**
     * Returns true if the authenticated user has the 'Admin' role.
     */
    function isAdmin() {
      return isSignedIn() && getUserData().role == 'Admin';
    }

    /**
     * Returns true if the authenticated user has the 'Supervisor' role.
     */
    function isSupervisor() {
      return isSignedIn() && getUserData().role == 'Supervisor';
    }

    /**
     * Returns true if the authenticated user has the 'Driver' role.
     */
    function isDriver() {
      return isSignedIn() && getUserData().role == 'Driver';
    }

    /**
     * Returns true if the authenticated user is either a Supervisor or an Admin.
     */
    function isSupervisorOrAdmin() {
        return isAdmin() || isSupervisor();
    }


    /**
     * @description A user can create their own profile. Once created, only that user can read or modify it. Admins can list all users for management.
     * @path /users/{userId}
     * @allow (create) An authenticated user with UID 'user123' creates their own profile at `/users/user123`.
     * @deny (get) User 'user456' attempts to read the profile at `/users/user123`.
     * @principle Restricts access to a user's own data tree (Self-Creation & Ownership).
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && isExistingDoc() && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && isExistingDoc();
    }

    /**
     * @description Any authenticated user can view vehicle information, but only Admins are permitted to add, modify, or remove vehicles.
     * @path /vehicles/{vehicleId}
     * @allow (get) Any signed-in 'Driver' or 'Supervisor' reads a vehicle's details.
     * @deny (create) A 'Supervisor' user attempts to add a new vehicle to the fleet.
     * @principle Role-Based Access Control (RBAC) for write operations.
     */
    match /vehicles/{vehicleId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Admins and Supervisors can view all jobs. Supervisors create jobs, and Drivers can only view jobs specifically assigned to them.
     * @path /jobs/{jobId}
     * @allow (create) A 'Supervisor' creates a new job, setting `requestingSupervisorId` to their own UID.
     * @deny (list) A 'Driver' attempts to list all jobs in the system.
     * @principle Denormalized, attribute-based access control for multiple roles.
     */
    match /jobs/{jobId} {
      allow get: if isSupervisorOrAdmin() || (isDriver() && resource.data.assignedDriverId == request.auth.uid);
      allow list: if isSupervisorOrAdmin();
      allow create: if isSupervisor() && request.resource.data.requestingSupervisorId == request.auth.uid;
      allow update: if isExistingDoc() && (isAdmin() || (isSupervisor() && resource.data.requestingSupervisorId == request.auth.uid) || (isDriver() && resource.data.assignedDriverId == request.auth.uid));
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Activity logs are for auditing. They are read-only for Admins and cannot be created, updated, or deleted from the client to ensure integrity.
     * @path /activity_logs/{activityLogId}
     * @allow (get) An 'Admin' user reads a log entry to investigate an incident.
     * @deny (create) Any user attempts to create a new log entry from the client application.
     * @principle Write-once, admin-read collection, protected from client manipulation. Writes should only occur via a trusted backend with Admin SDK.
     */
    match /activity_logs/{activityLogId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if false; // Must be created by a trusted server process
      allow update: if false; // Logs are immutable
      allow delete: if false; // Logs are immutable
    }

    /**
     * @description AI suggestions are read-only for Admins and Supervisors. They are generated by a backend process and cannot be modified by clients.
     * @path /ai_suggestions/{aiSuggestionId}
     * @allow (list) A 'Supervisor' lists AI suggestions to help assign drivers to new jobs.
     * @deny (create) Any user attempts to create their own AI suggestion.
     * @principle Read-only data for privileged roles, created by a trusted backend.
     */
    match /ai_suggestions/{aiSuggestionId} {
      allow get: if isSupervisorOrAdmin();
      allow list: if isSupervisorOrAdmin();
      allow create: if false; // Must be created by a trusted server process
      allow update: if false; // Suggestions are immutable
      allow delete: if false; // Suggestions are immutable
    }
  }
}
